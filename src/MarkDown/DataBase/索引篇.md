# 什么是索引
索引是在大数据量数据库内查询数据时的利器，如果说程序优化的万金油是缓存，那么sql优化的万金油就是索引。当然并不是一股脑加索引就完事的，因为索引是一种空间换时间的做法，不必要的索引会占据大量空间，并且影响数据的变更效率。
### 为什么索引可以快速定位
可以理解为建立索引就是在数据库提前准备了一份目录，目录按照你指定的索引字段有序排序，这样当你进行查询的时候，不用从头开始翻页找，而是直接通过目录定位到关键位置寻找。
### 为什么索引不能随意创建
由于索引需要有序排序，所以数据库需要一直维护索引的有序性，因此，在进行数据变更的时候，数据库需要消耗性能去将索引进行排序，如果你建的索引是没必要的，用不到的，那么就会浪费数据库性能，并且还要占据一部分磁盘空间。

# 索引的数据结构
我们知道，数据库的数据都是存放在磁盘的，而对磁盘进行I/O操作是一个十分耗时的操作，因此，如何减少I/O操作就是决定数据库查询性能的重要因素。在没有索引的情况下，数据行在磁盘种的存储结构是堆，而在建立索引后，数据行会依据**聚集索引**建立为树

## B+树
B+树是B树的改版，是为了更符合数据库的存储结构，优化索引查询效率设计的，和B树相比，它主要有两个特点
1. B+树的子节点不存储具体数据，只存有索引值，只有在最后的叶子节点上存储数据
2. B+树的叶子节点形成了有序双向链表的数据结构

### 使用B+树的原因
1. 由上面第一点可知，由于B+树的数据都存放在叶子节点，比起B树在每个子节点都存放了数据，在子节点的存储量上，B+树能比B树多存储更多的索引值。因此，在对磁盘进行I/O操作的时候，能获取更多的索引值，降低了树的高度，也因此减少了查询的I/O次数
2. 因为B+树的数据都存放在叶子节点，相比于B树在子节点就能找到数据并返回，B+树结构下的索引查询更稳定，不会有偶发的快慢问题。
3. 由于第二点，B+数的叶子节点形成了有序双向链表的结构，在进行范围查询的时候，能够直接在叶子节点查询，无须返回上一层的子节点进行比较，也就是说B+树在范围查询的效率上比B树要快。

# 聚集索引和非聚集索引
聚集索引是表数据在磁盘存储顺序的标准，因此每一个表只能有一个聚集索引，因为数据在磁盘只保存一份。
聚集索引的叶子节点存放的是具体数据。
非聚集索引可以有多个，它在子节点存放的除了自己的索引值外，还要聚集索引的索引值，在没实现**索引覆盖**的情况下，通过非聚集索引查询完后，需要到聚集索引再进行查询，也就是所谓的**回表**

# 索引覆盖与回表查询
索引覆盖是指在使用非聚集索引进行查询的时候，若查询的字段在索引里都存在，那么将不必进行回表操作，到聚集索引那查询数据，而是直接返回索引值。
比如我们在表TT里建立了 a+b+c的组合索引,表字段有id,a,b,c,d，id为聚集索引
```
//由于b在组合索引内，所以无需回表
select a,b from TT where a=1
//由于d不在组合索引内，所以需要回表
select a,b,c,d from TT where a=1
//由于id为主键值在叶子节点存在，所以无需回表
select a,id from TT where a=1
```
# 索引失效
由于索引的在查询时的重要性，所以在编写sql的时候，如何让索引命中就是sql优化的重点。下面总结了几个索引失效的情况

1. 使用左模糊或左右模糊：因为索引是按照索引值进行有序排列的，有序排列顺序是按照值从左往右匹配排序，因此在左模糊的情况下，只能进行全表查询。
2. 对索引使用函数： 因为索引有序排序排序的是原始值，在进行函数计算之后的索引已经无法使用原来的索引目录了。不过可以建立函数索引实现。
3. 索引隐式类型转换：这是最容易犯错的一点，当我们对字符串类型的索引使用int类型的值比较时，但是对int字段的索引使用字符串时则不会，因为数据库会默认将字符串改为int值进行比较，所以第一个情况会出现索引失效，第二个不会。
4. 对索引使用表达式运算，原理和使用函数一致，计算后的值无法和索引目录匹配了。
5. where语句中的or，当or判断中一个走索引，一个没走索引，那么索引将失效，因为有一个没走索引，那么将进行全表查询，执行另一个索引就没有意义了。
6. 非最左匹配，因为索引目录在建立的时候，是按照最左匹配原则搭建的，当查询时没依据最左匹配原则，在前面的条件不满足的情况下，后面的排序是乱序的，无法进行二分查找，因此索引失效。注意：非最左匹配和where条件内的查询顺序无关，因为sql引擎会自动优化匹配索引。非最左匹配指的是建立了组合索引，在前面的索引没写的情况下只时候后面的索引将导致索引失效。

# 文档指引
本篇文章为自己的索引知识点总结，下面是参考的知识链接
1. 小林Coding：https://xiaolincoding.com/mysql/index/index_interview.html
2. 知乎：https://zhuanlan.zhihu.com/p/479640984
3. CSDN：https://bbs.csdn.net/topics/80212700#Top